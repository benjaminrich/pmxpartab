---
title: "Introduction to `pmxpartab`"
author: "Benjamin Rich"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    css: vignette.css
    toc: true
vignette: >
  %\VignetteIndexEntry{Introduction to `pmxpartab`}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteDepends{yaml}
  %\VignetteEncoding{UTF-8}
---

```{r echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
library(pmxpartab, quietly=TRUE)
```

## Introduction

This R package produces nice looking parameter tables for pharmacometric modeling
results with ease. It is completely agnostic to the modeling software that was
used.

## Usage

The creation of the parameter table proceeds in 2 steps:

1. Generate an intermediate `data.frame` from a list of outputs and metadata.
2. Genreate an HTML table from the intermediate `data.frame`.

For the first step, the imputs are:

1. Model outputs (parameter estimates, standard errors, etc.)
2. Metadata, describing the outputs (labels, units, transformations, etc.)

To keep things generic, both the model outputs and metadata must be provided
as R lists (it is a separate problem to extract the outputs from the modeling
software into the required list format).

For illustration, we will use a YAML description of the outputs and metadata,
which can easily be read into R. First, the outputs:


```{r}
library(yaml)

outputs <- yaml.load("
est:
  CL:   0.482334
  VC:   0.0592686
  nCL:  0.315414
  nVC:  0.536025
  ERRP: 0.0508497
se:
  CL:   0.0138646
  VC:   0.0055512
  nCL:  0.0188891
  nVC:  0.0900352
  ERRP: 0.0018285
fixed:
  CL:   no
  VC:   no
  nCL:  no
  nVC:  no
  ERRP: no
shrinkage:
  nCL:  9.54556
  nVC:  47.8771
")
```

We see that the outputs are split into separate sections: `est` for estimates,
`se` for standard errors, `fixed` for indicating which parameters were fixed
rather than estimated, `shrinkage` for shrinkage estimates.

Now, the metadata:

```{r}
meta <- yaml.load("
parameters:
- name:  CL
  label: 'Clearance'
  units: 'L/h'
  type:  Structural

- name:  VC
  label: 'Volume'
  units: 'L'
  type:  Structural
  trans: 'exp'
  
- name:  nCL
  label: 'On Clearance'
  type:  IIV
  trans: 'SD (CV%)'
  
- name:  nVC
  label: 'On Volume'
  type:  IIV
  trans: 'SD (CV%)'
  
- name:  ERRP
  label: 'Proportional Error'
  units: '%'
  type:  RUV
  trans: '%'
")
```

Here, the first important thing is the `name`, which must match the names of
the parameters in the outputs. Then, we have some optional attributes: a
descriptive `label`, the `units` if applicable, a transformation `trans`, and
a `type`.


Putting this all together, we can produce a `data.frame` like this:

```{r}
parframe <- pmxparframe(outputs, meta)
parframe
```

Finally, our nicely formatted table looks like this:

```{r}
pmxpartab(parframe)
```

We can also do this in one shot, and add footnotes as well:

```{r}
footnote <- c(
    "CI=confidence interval; RSE=relative standard error.",
    "Source: run001")

pmxpartab(pmxparframe(outputs, meta), footnote=footnote)
```

It is also possible to  use the pipe syntax:

```{r}
outputs |> pmxparframe(meta) |> pmxpartab(footnote=footnote)
```


## Random effects and off-diagonal elements


There is some debate on the best way to present the random effects from a
mixed-effects model (ie, the parameter(s) that describe the (joint)
distribution of the random effects, which are typically assumed to follow a
multivariate normal distribution).  Some modelers are used to seeing the
variances and covariances, while others (such as this author) prefer the
standard deviations and correlations. In any case, `pmxpartab` is agnostic to
this choice, and gives freedom and flexibility in this respect.

If following conventions, between-individual random effect parameters are
contained in the `om` component of `est`, `se` and `fixed` (they can also be at
the top level).  Thus, one may have something like:

```{r}
outputs <- yaml.load("
est:
  nCL:     0.0994859
  nVC:     0.2873220
  nCL_nVC: 0.0133415
se:
  nCL:  0.0188891
  nVC:  0.0900352
")

meta <- yaml.load("
parameters:
- name:  'nCL'
  label: 'On Clearance'
  type:  IIV

- name:  'nVC'
  label: 'On Volume'
  type:  IIV

- name:  'nCL_nVC'
  label: 'Covariance CL-Vc'
  type:  IIV
")

outputs |> pmxparframe(meta) |> pmxpartab()
```



```{r}

om_names <- c("nCL", "nVC")

om_cov <- matrix(c(0.0994859, 0.0133415, 0.0133415, 0.287322), 2, 2)
dimnames(om_cov) <- list(om_names, om_names)
om_cov

library(linpk)
om_cov <- linpk::LTmat(c(0.0994859, 0.0133415, 0.287322))
dimnames(om_cov) <- list(om_names, om_names)
om_cov

om_cor <- cov2cor(om_cov)
diag(om_cor) <- sqrt(diag(om_cov))
dimnames(om_cor) <- list(om_names, om_names)
om_cor

outputs$est$om_cov <- om_cov
outputs$est$om_cor <- om_cor
outputs$est$om <- sqrt(diag(om_cov))

meta <- yaml.load("
parameters:
- name:  'nCL'
  label: 'On Clearance'
  type:  IIV

- name:  'nVC'
  label: 'On Volume'
  type:  IIV

- name:  'om_cov(nCL,nVC)'
  label: 'Covariance'
  type:  IIV

- name:  'om_cor(nCL,nVC)'
  label: 'Correlation'
  type:  IIV
")

outputs |> pmxparframe(meta) |> pmxpartab()
```

## Bootstrap results

TBD
